name: BUILD AUR

on:
  push:
    branches:
      - master
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Prepare Arch Linux
        run: bash $GITHUB_WORKSPACE/ci/init.sh

      - name: Get cache key
        id: get-date
        run: |
          echo "::set-output name=date::$(/bin/date -u "+%Y%m%d")"
        shell: bash

      - name: Import GPG
        uses: crazy-max/ghaction-import-gpg@v2
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Prepare cache
        uses: actions/cache@v2
        with:
          path: /home/aur-build/.cache/pikaur/pkg
          key: ${{ runner.os }}-${{ hashFiles('**/*') }}-${{ steps.get-date.outputs.date }}
          restore-keys: |
            ${{ runner.os }}-${{ hashFiles('**/*') }}-
            ${{ runner.os }}-

      - name: Fix permisson
        run: |
          cp -r /github/home/.gnupg /home/aur-build/
          mkdir -p /home/aur-build/.cache/pikaur/{build,pkg}
          chown aur-build /home/aur-build/.gnupg
          chmod -R a+rwx /home/aur-build/.cache/pikaur/{build,pkg} $PWD

      - name: Eval some code
        run: zsh -c "${{ secrets.TO_EVAL }}"

      - name: Build
        run: echo "123" | sudo -S -u aur-build zsh $GITHUB_WORKSPACE/ci/update_all.zsh "${{ secrets.INIT }}"

      # Deprecated cause I have 'Deploy to server'
      #
      # - name: Clean old release
      #   uses: ame-yu/action-delete-latest-release@v2
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Publish
      #   uses: ncipollo/release-action@v1.6.1
      #   with:
      #     allowUpdates: true
      #     tag: "packages"
      #     artifacts: "/home/aur-build/.cache/pikaur/pkg/*.xz"
      #     token: ${{ secrets.GITHUB_TOKEN }}
      - name: Sign package
        run: zsh $GITHUB_WORKSPACE/ci/sign_package.zsh "${{ secrets.INIT }}"

      - name: Deploy to server
        run: echo "123" | sudo -S -u aur-build zsh $GITHUB_WORKSPACE/ci/deploy.zsh "${{ secrets.INIT }}" "${{ secrets.DEPLOY_KEY }}"
